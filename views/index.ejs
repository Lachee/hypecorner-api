<html>
    <title>HypeCorner Embed Player</title>
    <style>
        * { padding: 0; margin: 0; }
    </style>
    <body>
        <!-- Add a placeholder for the Twitch embed -->
        <div id="twitch-embed"></div>

        <!-- Load the Twitch embed script -->
        <script src="https://embed.twitch.tv/embed/v1.js"></script>

        <!-- Create a Twitch.Embed object that will render within the "twitch-embed" root element. -->
        <script type="text/javascript">
            var twitchChannel = "<%= channel %>";
            var twitchEmbed = new Twitch.Embed("twitch-embed", {
                channel: twitchChannel,
                layout: "<%= chat ? 'video-chat' : 'video' %>",
                height: "100%",
                width: "100%",
            });

            var protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            var host = protocol + "//" + window.location.host + "/listen";
     
            connect(host);
            function connect(host) {
                
                //Connect and listen to events
                var ws = new WebSocket(host);

                //We opened
                ws.addEventListener("open", (event) => { 
                    console.log("open", event);
                    fetch('/api/channel').then(async (data) => {
                        var result = data.json();
                        updateChannel(result.name);
                    });
                });

                //We closed, reconnect
                ws.addEventListener("close", (event) => { 
                    console.warn("Live Watch has terminated", event); 
                    connect(host);
                });
                
                //New Channel
                ws.addEventListener("message", (event) => { 
                    updateChannel(event.data);
                });
            }

            function updateChannel(name) {
                if (name != twitchChannel) {
                    console.log("New Channel", name);
                    twitchChannel = name;                
                    twitchEmbed.setChannel(twitchChannel);
                }
            }
        </script>
        
		<!-- Live Updating -->
		<script>
	
		</script>
    </body>
</html>